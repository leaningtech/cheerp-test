import lit.formats
import os

config.name = 'Cheerp-testing-suite'
config.test_source_root = os.path.dirname(__file__)
config.test_format = lit.formats.ShTest(execute_external=True)
config.suffixes = ['.cpp', '.c']

comp_base = '/home/alex/cheerp/cheerp-compiler/build/bin/clang++'
comp_alt = ""

cheerp_targets = ["js", "wasm", "asmjs"]

# Parse preexecution mode parameter
# PRE_EX=0 or empty: no preexecution
# PRE_EX=j or PRE_EX=js: js preexecution only
# PRE_EX=a or PRE_EX=asmjs: asmjs preexecution only
# PRE_EX=1 or PRE_EX=true: both js and asmjs preexecution
preex_param = lit_config.params.get('PRE_EX', '0').strip().lower()
preexecute_wasm = False
preexecute_asmjs = False

if preex_param in ['1', 'true', 'yes', 'both']:
    preexecute_wasm = True
    preexecute_asmjs = True
elif preex_param in ['j', 'wasm', 'js']:
    preexecute_wasm = True
elif preex_param in ['a', 'asmjs']:
    preexecute_asmjs = True

# For backward compatibility, keep preexecute_mode as True if any preexecution is enabled
preexecute_mode = preexecute_wasm or preexecute_asmjs

targets_csv = lit_config.params.get("TARGET", "").strip()
cheerp_flags = lit_config.params.get('CHEERP_FLAGS', "").strip()
extra_flags = lit_config.params.get('EXTRA_FLAGS', "").strip()
opt_level = lit_config.params.get('OPT_LEVEL', 'O1').strip()
# Ensure opt_level has proper format (-O prefix)
if not opt_level.startswith('-'):
    if not opt_level.startswith('O'):
        opt_level = '-O' + opt_level
    else:
        opt_level = '-' + opt_level
comp = lit_config.params.get('COMPILER', 'cheerp').strip()
if comp == 'cheerp':
    comp_base = '/opt/cheerp/bin/clang++'
elif comp == 'cheerp-clang':
    comp_base = '/opt/cheerp/bin/cheerp-clang++'
elif comp == 'cheerp alt':
    comp_base = '/home/alex/cheerp/cheerp-compiler/build/bin/clang++'
    extra_flags = (extra_flags + ' -isystem /opt/cheerp/include -isystem /opt/cheerp/include/client').strip() 
else:
    comp_base = comp  # Use custom compiler path

# NOTE: should be redundant with the PRE_EX param
# # Auto-detect preexecution mode from flags
# if '-preexecute' in cheerp_flags or '-cheerp-preexecute' in cheerp_flags:
#  eexecute_mode = True
#     cheerp_flags = cheerp_flags.replace('-preexecute', '').strip()
#     cheerp_flags = cheerp_flags.replace('-cheerp-preexecute', '').strip()
#     cheerp_flags = cheerp_flags.replace('-mllvm -cheerp-preexecute-main', '').strip()
#     cheerp_flags = cheerp_flags.replace('-DPRE_EXECUTE_TEST', '').strip()

# Parse -valgrind option from cheerp_flags
valgrind_mode = False
if '-valgrind' in cheerp_flags:
    valgrind_mode = True
    # Remove -valgrind from cheerp_flags since it's not a compiler flag
    cheerp_flags = cheerp_flags.replace('-valgrind', '').strip()

asan_mode = False
if '-asan' in cheerp_flags:
    asan_mode = True
    # Remove -asan from cheerp_flags since it's not a compiler flag
    cheerp_flags = cheerp_flags.replace('-asan', '').strip()

# ASAN will be applied per-target automatically when asan_mode is True, remove explicit call to prevent js target contamination. 
# NOTE: this is most likely redundant, it is an extra safety measure.
# cheerp_flags = cheerp_flags.replace('-fsanitize=address', '').strip()
# extra_flags = extra_flags.replace('-fsanitize=address', '').strip()

selected_targets = []
for t in targets_csv.split(","):
    if t.strip().lower() in cheerp_targets:
        selected_targets.append(t);
if not selected_targets:
    # Default to all targets
    selected_targets = set(cheerp_targets)
    # NOTE: If ASAN is enabled, automatically exclude JS target. JS cannot work with ASAN.
    if asan_mode:
        selected_targets.discard('js')
        lit_config.warning('ASAN enabled: automatically excluding JS target (use --param TARGET="js,wasm,asmjs" to override)')

lit_config.note('Selected targets: {}'.format(selected_targets))

# print modes to terminal for clarity
if preexecute_mode:
    modes = []
    if preexecute_wasm:
        modes.append('wasm/js')
    if preexecute_asmjs:
        modes.append('asmjs')
    lit_config.note('Preexecution mode ENABLED: {}'.format(', '.join(modes)))
else:
    lit_config.note('Preexecution mode DISABLED')

if valgrind_mode:
    lit_config.note('Valgrind mode ENABLED')
else:
    lit_config.note('Valgrind mode DISABLED')

if asan_mode:
    lit_config.note("ASAN mode ENABLED (only applies to wasm/asmjs targets)")
else:
    lit_config.note("ASAN mode DISABLED")

lit_config.note('Optimization level: {}'.format(opt_level))
lit_config.note('Compiler: {}'.format(comp_base))

all_flags = ' '.join(filter(None, [cheerp_flags, extra_flags]))
cheerp_cmd = comp_base + (' ' + all_flags if all_flags else '')

# Preexecution-specific flags
preexecute_flags = '-DPRE_EXECUTE_TEST -cheerp-preexecute -mllvm -cheerp-preexecute-main'
if preexecute_mode:
    cheerp_cmd_preexec = comp_base + ' ' + preexecute_flags + (' ' + all_flags if all_flags else '')
else:
    cheerp_cmd_preexec = None

if cheerp_flags:
    lit_config.note('Cheerp flags: {}'.format(cheerp_flags))
else:
    lit_config.note('No Cheerp flags set')

if extra_flags:
    lit_config.note('Extra flags: {}'.format(extra_flags))
else:
    lit_config.note('No extra flags set')

# Define features for test REQUIRES directives
if not asan_mode:
    config.available_features.add('no-asan')
if asan_mode:
    config.available_features.add('asan')

if preexecute_mode:
    config.available_features.add('preexecution')
else:
    config.available_features.add('regular')

if "js" in selected_targets:
    config.available_features.add('js')
if "wasm" in selected_targets:
    config.available_features.add('wasm')
if "asmjs" in selected_targets:
    config.available_features.add('asmjs')
if "wasm" in selected_targets or "asmjs" in selected_targets:
    config.available_features.add('linear-memory')
if "wasm" in selected_targets or "js" in selected_targets:
    config.available_features.add('packed_tests')

if valgrind_mode:
    config.available_features.add('valgrind')
else:
    config.available_features.add('no-valgrind')

# Basic substitutions
config.substitutions.append(('%FileCheck', '/usr/bin/FileCheck-20'))
config.substitutions.append(('%node', 'node'))

# EXPERIMENTAL: Unified pipeline macros for preexecution mode
# NOTE: I commented out the wasm/asmjs ones for now since preexecution doesn't support them
# In regular mode: compile to file, then run with node
# In preexec mode: just compile (compiler outputs CHECK lines to stderr)
if preexecute_mode:
    # In preexecution mode: all macros expand to nothing (don't run with node)
    # Must add target-specific ones first so they match before generic patterns
    config.substitutions.append(('%then_run_js', ''))
    # config.substitutions.append(('%then_run_wasm', ''))
    # config.substitutions.append(('%then_run_asmjs', ''))
else:
    # In regular mode: run the output files with node
    config.substitutions.append(('%then_run_js', '&& node %t/j'))
    # config.substitutions.append(('%then_run_wasm', '&& node %t/w'))
    # config.substitutions.append(('%then_run_asmjs', '&& node %t/a'))

# Valgrind support - Note: valgrind is now built into compile commands
# This substitution is kept for backward compatibility or manual use
if valgrind_mode:
    config.substitutions.append(('%valgrind', 'valgrind -q'))
else:
    config.substitutions.append(('%valgrind', ''))

# Compile macros: compile_for_<target> and compile_for_preexec_<target>
# Expands to compilation command or 'true' if target disabled
# NOTE: asmjs uses cheerp-wasm target + -cheerp-linear-output=asmjs flag
target_flags = {
    'wasm': '-target cheerp-wasm',
    'js': '-target cheerp',
    'asmjs': '-target cheerp-wasm -cheerp-linear-output=asmjs'
}

for target, flag in target_flags.items():
    target_cheerp_cmd = cheerp_cmd
    
    # IMPORTANT: ASAN only for wasm/asmjs, NEVER for js
    if asan_mode and (target == 'wasm' or target == 'asmjs'):
        target_cheerp_cmd += ' -fsanitize=address'
    # Explicitly ensure no ASAN leaks into JS target
    elif asan_mode and target == 'js':
        # Remove any accidental -fsanitize flags for JS target
        target_cheerp_cmd = target_cheerp_cmd.replace('-fsanitize=address', '')
    
    # Wrap with valgrind if enabled
    if valgrind_mode:
        target_cheerp_cmd = 'valgrind -q ' + target_cheerp_cmd
    
    if target in selected_targets:
        # Regular compile macros
        config.substitutions.append((
            'compile_for_' + target,
            target_cheerp_cmd + ' ' + opt_level + ' -frtti -cheerp-bounds-check -cheerp-fix-wrong-func-casts -I' + os.path.dirname(__file__) + ' ' + flag
        ))
        # Preexecution compile macros - wasm never supports preexecution
        if target == 'wasm':
            # Wasm does not support preexecution
            config.substitutions.append((
                'compile_for_preexec_' + target,
                'true'
            ))
        elif target == 'js' and preexecute_wasm and cheerp_cmd_preexec:
            # JS target with wasm preexecution mode
            target_preexec_cmd = cheerp_cmd_preexec
            if valgrind_mode:
                target_preexec_cmd = 'valgrind -q ' + target_preexec_cmd
            config.substitutions.append((
                'compile_for_preexec_' + target,
                target_preexec_cmd + ' ' + opt_level + ' -frtti -cheerp-bounds-check -cheerp-fix-wrong-func-casts -I' + os.path.dirname(__file__) + ' ' + flag
            ))
        elif target == 'asmjs' and preexecute_asmjs and cheerp_cmd_preexec:
            # Asmjs target with asmjs preexecution mode
            target_preexec_cmd = cheerp_cmd_preexec
            if valgrind_mode:
                target_preexec_cmd = 'valgrind -q ' + target_preexec_cmd
            config.substitutions.append((
                'compile_for_preexec_' + target,
                target_preexec_cmd + ' ' + opt_level + ' -frtti -cheerp-bounds-check -cheerp-fix-wrong-func-casts -I' + os.path.dirname(__file__) + ' ' + flag
            ))
        else:
            config.substitutions.append((
                'compile_for_preexec_' + target,
                'true'
            ))
    else:
        # Replace with 'true' to avoid errors when target is disabled
        config.substitutions.append((
            'compile_for_' + target,
            'true'
        ))
        config.substitutions.append((
            'compile_for_preexec_' + target,
            'true'
        ))

if preexecute_mode:
    # In preexecution mode: keep preexec_only, skip regular_only, replace it with 'true'
    config.substitutions.append(('preexec_only ', ''))
    config.substitutions.append(('regular_only .*', 'true'))
else:
    # In regular mode: keep regular_only, skip preexec_only
    config.substitutions.append(('regular_only ', ''))
    config.substitutions.append(('preexec_only .*', 'true'))

# Apply run_if patterns AFTER mode-specific patterns so they take precedence
for target in cheerp_targets:
    # Determine if this target should be enabled based on mode
    target_should_run = False
    
    if preexecute_mode:
        # In preexecution mode: check which preexec mode is active
        if target == 'js' and preexecute_wasm:
            target_should_run = True
        elif target == 'asmjs' and preexecute_asmjs:
            target_should_run = True
        # wasm never runs in preexecution mode
    else:
        # In regular mode: target runs if it's in selected_targets
        if target in selected_targets:
            target_should_run = True
    
    if target_should_run:
        # Target enabled - remove the macro name (runs the command as-is)
        config.substitutions.append((
            'run_if_' + target + ' ',
            ''
        ))
    else:
        # Target disabled - replace entire line with 'true'
        config.substitutions.append((
            'run_if_' + target + '[^\n]*',
            'true'
        ))

# Mode-specific compile macros for all targets (enabled and disabled)
for target, flag in target_flags.items():
    if target in selected_targets:
        # Check if this target should use preexecution
        use_preexec = False
        if target == 'js' and preexecute_wasm:
            use_preexec = True
        elif target == 'asmjs' and preexecute_asmjs:
            use_preexec = True
        
        if use_preexec and cheerp_cmd_preexec:
            # Use preexecution mode for this target
            # Note: ASAN not supported in preexecution mode (matching run_tests.py behavior)
            mode_cmd = cheerp_cmd_preexec
            if valgrind_mode:
                mode_cmd = 'valgrind -q ' + mode_cmd
            config.substitutions.append((
                'compile_mode_' + target,
                mode_cmd + ' ' + opt_level + ' -frtti -cheerp-bounds-check -cheerp-fix-wrong-func-casts -I' + os.path.dirname(__file__) + ' ' + flag
            ))
        else:
            # In regular mode: use regular commands
            mode_cmd = cheerp_cmd
            
            # IMPORTANT: ASAN only for wasm/asmjs, NEVER for js
            if asan_mode and (target == 'wasm' or target == 'asmjs'):
                mode_cmd += ' -fsanitize=address'
            # Ensure no ASAN leaks into JS target
            elif asan_mode and target == 'js':
                # Remove any accidental -fsanitize flags for JS target
                mode_cmd = mode_cmd.replace('-fsanitize=address', '')
            
            if valgrind_mode:
                mode_cmd = 'valgrind -q ' + mode_cmd
            
            config.substitutions.append((
                'compile_mode_' + target,
                mode_cmd + ' ' + opt_level + ' -frtti -cheerp-bounds-check -cheerp-fix-wrong-func-casts -I' + os.path.dirname(__file__) + ' ' + flag
            ))
    else:
        # Target is disabled - replace with 'true'
        config.substitutions.append((
            'compile_mode_' + target,
            'true'
        ))

config.test_exec_root = os.path.dirname(__file__)
# Ensure Cheerp tools (like llc for -cheerp-no-lto) are in PATH
if 'PATH' in os.environ:
    config.environment['PATH'] = '/opt/cheerp/bin:' + os.environ['PATH']
else:
    config.environment['PATH'] = '/opt/cheerp/bin:/usr/bin:/bin'
