import lit.formats
import os

config.name = 'Cheerp-testing-suite'
config.test_source_root = os.path.dirname(__file__)
config.test_format = lit.formats.ShTest(execute_external=True)
config.suffixes = ['.cpp', '.c']

cheerp_base = '/opt/cheerp/bin/clang++'

cheerp_targets = ["js", "wasm", "asmjs"]
preexecute_mode = lit_config.params.get('PRE-EX', "").strip()
if (preexecute_mode.lower() in ['1', 'true', 'yes']):
    preexecute_mode = True
else:
    preexecute_mode = False
targets_csv = lit_config.params.get("TARGET", "").strip()
cheerp_flags = lit_config.params.get('CHEERP_FLAGS', "").strip()
extra_flags = lit_config.params.get('EXTRA_FLAGS', "").strip()


# Parse -valgrind option from cheerp_flags
valgrind_mode = False
if '-valgrind' in cheerp_flags:
    valgrind_mode = True
    # Remove -valgrind from cheerp_flags since it's not a compiler flag
    cheerp_flags = cheerp_flags.replace('-valgrind', '').strip()

selected_targets = []
for t in targets_csv.split(","):
    if t.strip().lower() in cheerp_targets:
        selected_targets.append(t);
if not selected_targets:
    selected_targets = set(cheerp_targets)

lit_config.note('Selected targets: {}'.format(selected_targets))

if preexecute_mode:
    lit_config.note('Preexecution mode ENABLED')
else:
    lit_config.note('Preexecution mode DISABLED')

if valgrind_mode:
    lit_config.note('Valgrind mode ENABLED')
else:
    lit_config.note('Valgrind mode DISABLED')

all_flags = ' '.join(filter(None, [cheerp_flags, extra_flags]))
cheerp_cmd = cheerp_base + (' ' + all_flags if all_flags else '')

# Preexecution-specific flags
preexecute_flags = '-DPRE_EXECUTE_TEST -cheerp-preexecute -mllvm -cheerp-preexecute-main'
if preexecute_mode:
    cheerp_cmd_preexec = cheerp_base + ' ' + preexecute_flags + (' ' + all_flags if all_flags else '')
else:
    cheerp_cmd_preexec = None

if cheerp_flags:
    lit_config.note('Cheerp flags: {}'.format(cheerp_flags))
else:
    lit_config.note('No Cheerp flags set')
if extra_flags:
    lit_config.note('Extra flags: {}'.format(extra_flags))
else:
    lit_config.note('No extra flags set')

# Basic substitutions
config.substitutions.append(('%FileCheck', '/usr/bin/FileCheck-20'))
config.substitutions.append(('%node', 'node'))

# Valgrind support
if valgrind_mode:
    config.substitutions.append(('%valgrind', 'valgrind -q'))
else:
    config.substitutions.append(('%valgrind', ''))

# Compile macros: compile_for_<target> and compile_for_preexec_<target>
# Expands to compilation command or 'true' if target disabled
target_flags = {
    'wasm': '-target cheerp-wasm',
    'js': '-target cheerp',
    'asmjs': '-target cheerp-asmjs'
}

for target, flag in target_flags.items():
    if target in selected_targets:
        # Regular compile macros
        config.substitutions.append((
            'compile_for_' + target,
            cheerp_cmd + ' -O1 -frtti -cheerp-bounds-check -cheerp-fix-wrong-func-casts -I' + os.path.dirname(__file__) + ' ' + flag
        ))
        # Preexecution compile macros - only for js and asmjs, NOT for wasm
        if target == 'wasm':
            # Wasm does not support preexecution
            config.substitutions.append((
                'compile_for_preexec_' + target,
                'true'
            ))
        elif preexecute_mode and cheerp_cmd_preexec:
            config.substitutions.append((
                'compile_for_preexec_' + target,
                cheerp_cmd_preexec + ' -O1 -frtti -cheerp-bounds-check -cheerp-fix-wrong-func-casts -I' + os.path.dirname(__file__) + ' ' + flag
            ))
        else:
            config.substitutions.append((
                'compile_for_preexec_' + target,
                'true'
            ))
    else:
        # Replace with 'true' to avoid errors when target is disabled
        config.substitutions.append((
            'compile_for_' + target,
            'true'
        ))
        config.substitutions.append((
            'compile_for_preexec_' + target,
            'true'
        ))

if preexecute_mode:
    # In preexecution mode: keep preexec_only, skip regular_only
    config.substitutions.append(('preexec_only ', ''))
    # For regular_only lines, replace from keyword to end with 'true'
    config.substitutions.append(('regular_only .*', 'true'))
else:
    # In regular mode: keep regular_only, skip preexec_only
    config.substitutions.append(('regular_only ', ''))
    # For preexec_only lines, replace from keyword to end with 'true'
    config.substitutions.append(('preexec_only .*', 'true'))

# Apply run_if patterns AFTER mode-specific patterns so they take precedence
for target in cheerp_targets:
    if target in selected_targets:
        # Target enabled - remove the macro name (runs the command as-is)
        config.substitutions.append((
            'run_if_' + target + ' ',
            ''
        ))
    else:
        # Target disabled - replace entire line with 'true'
        config.substitutions.append((
            'run_if_' + target + '[^\n]*',
            'true'
        ))

# Mode-specific compile macros for all targets (enabled and disabled)
for target, flag in target_flags.items():
    if target in selected_targets:
        if target != 'wasm' and preexecute_mode:
            # Wasm never has preexecution variant
            config.substitutions.append((
                'compile_mode_' + target,
                cheerp_cmd_preexec + ' -O1 -frtti -cheerp-bounds-check -cheerp-fix-wrong-func-casts -I' + os.path.dirname(__file__) + ' ' + flag
            ))
        else:
            # In regular mode: use regular commands
            config.substitutions.append((
                'compile_mode_' + target,
                cheerp_cmd + ' -O1 -frtti -cheerp-bounds-check -cheerp-fix-wrong-func-casts -I' + os.path.dirname(__file__) + ' ' + flag
            ))
    else:
        # Target is disabled - replace with 'true'
        config.substitutions.append((
            'compile_mode_' + target,
            'true'
        ))

config.test_exec_root = os.path.dirname(__file__)
# Ensure Cheerp tools (like llc for -cheerp-no-lto) are in PATH
if 'PATH' in os.environ:
    config.environment['PATH'] = '/opt/cheerp/bin:' + os.environ['PATH']
else:
    config.environment['PATH'] = '/opt/cheerp/bin:/usr/bin:/bin'
