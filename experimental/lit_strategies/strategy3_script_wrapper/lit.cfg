# Strategy 3: Shell script wrapper approach
#
# This strategy uses an external shell script to handle all the conditional
# logic. The test files are very clean and readable, with complexity moved
# to the helper script.
#
# Pros:
# - Cleanest test files - extremely readable
# - Maximum flexibility in the helper script
# - Easy to add new features without changing lit.cfg
# - Can handle complex logic that's difficult in Python or shell conditionals
#
# Cons:
# - Requires maintaining a separate script
# - Slightly more indirection when debugging
# - Script needs to be distributed with tests

import lit.formats
import os

config.name = 'Cheerp-Strategy3'
config.test_source_root = os.path.dirname(__file__)
config.test_format = lit.formats.ShTest(execute_external=True)
config.suffixes = ['.cpp', '.c']

cheerp_base = '/opt/cheerp/bin/clang++'
cheerp_flags = os.environ.get('CHEERP_FLAGS', '')
extra_flags = os.environ.get('EXTRA_FLAGS', '')

cheerp_targets = ["js", "wasm", "asmjs"]
targets_csv = lit_config.params.get("TARGETS", "").strip()

if targets_csv:
    selected_targets = set([t.strip().lower() for t in targets_csv.split(",")])
else:
    selected_targets = set(cheerp_targets)

lit_config.note('Strategy 3: Script Wrapper - Selected targets: {}'.format(selected_targets))

all_flags = ' '.join(filter(None, [cheerp_flags, extra_flags]))
cheerp_cmd = cheerp_base + (' ' + all_flags if all_flags else '')

# Set environment variables for the helper script to use
config.environment["HAS_JS"] = "1" if "js" in selected_targets else "0"
config.environment["HAS_WASM"] = "1" if "wasm" in selected_targets else "0"
config.environment["HAS_ASMJS"] = "1" if "asmjs" in selected_targets else "0"
config.environment["CHEERP_CLANG"] = cheerp_cmd

# Path to the helper script
helper_script = os.path.join(os.path.dirname(__file__), 'test_helper.sh')

config.substitutions.append(('%test_helper', helper_script))
config.substitutions.append(('%FileCheck', '/usr/bin/FileCheck-20'))
config.substitutions.append(('%node', 'node'))

config.test_exec_root = os.path.dirname(__file__)
if 'PATH' in os.environ:
    config.environment['PATH'] = os.environ['PATH']
