# Strategy 5: Enhanced current approach
#
# This improves on the original approach by providing cleaner, more
# intuitive macro-style substitutions. Similar to Strategy 2 but with
# better naming conventions.
#
# Pros:
# - Familiar to those using the current approach
# - Clean, intuitive syntax
# - Easy to understand and maintain
# - Good balance of simplicity and flexibility
#
# Cons:
# - Still requires some regex knowledge for maintenance
# - Each target needs explicit handling

import lit.formats
import os

config.name = 'Cheerp-Strategy5'
config.test_source_root = os.path.dirname(__file__)
config.test_format = lit.formats.ShTest(execute_external=True)
config.suffixes = ['.cpp', '.c']

cheerp_base = '/opt/cheerp/bin/clang++'
cheerp_flags = os.environ.get('CHEERP_FLAGS', '')
extra_flags = os.environ.get('EXTRA_FLAGS', '')

cheerp_targets = ["js", "wasm", "asmjs"]
targets_csv = lit_config.params.get("TARGETS", "").strip()

if targets_csv:
    selected_targets = set([t.strip().lower() for t in targets_csv.split(",")])
else:
    selected_targets = set(cheerp_targets)

lit_config.note('Strategy 5: Enhanced Current - Selected targets: {}'.format(selected_targets))

all_flags = ' '.join(filter(None, [cheerp_flags, extra_flags]))
cheerp_cmd = cheerp_base + (' ' + all_flags if all_flags else '')

# Basic substitutions
config.substitutions.append(('%FileCheck', '/usr/bin/FileCheck-20'))
config.substitutions.append(('%node', 'node'))

# Compile macros: %compile_for{target} args
# Expands to compilation command or 'true' if target disabled
target_flags = {
    'wasm': '-target cheerp-wasm',
    'js': '-target cheerp',
    'asmjs': '-target cheerp-asmjs'
}

for target, flag in target_flags.items():
    if target in selected_targets:
        config.substitutions.append((
            r'%compile_for\{' + target + r'\}',
            cheerp_cmd + ' ' + flag
        ))
    else:
        # Replace with 'true' to avoid errors when target is disabled
        config.substitutions.append((
            r'%compile_for\{' + target + r'\}[^\n]*',
            'true'
        ))

# Execution macros: %run_if{target} command
# Expands to command or 'true' if target disabled
for target in ['wasm', 'js', 'asmjs']:
    if target in selected_targets:
        # Target enabled - run the command as-is
        config.substitutions.append((
            r'%run_if\{' + target + r'\} ',
            ''
        ))
    else:
        # Target disabled - replace entire line with 'true'
        config.substitutions.append((
            r'%run_if\{' + target + r'\}[^\n]*',
            'true'
        ))

config.test_exec_root = os.path.dirname(__file__)
if 'PATH' in os.environ:
    config.environment['PATH'] = os.environ['PATH']
