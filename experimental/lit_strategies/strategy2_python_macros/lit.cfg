# Strategy 2: Python-based macro substitution
#
# This strategy uses Python regex in lit substitutions to create custom "macros"
# that expand into conditional shell commands. The macros use braces {} syntax
# to wrap commands that should only run for specific targets.
#
# Pros:
# - More flexible than REQUIRES - can conditionally run individual RUN lines
# - Clean, readable syntax in test files
# - All logic centralized in lit.cfg
#
# Cons:
# - Slightly more complex lit.cfg setup
# - Uses regex substitutions which can be tricky to debug

import lit.formats
import os
import re

config.name = 'Cheerp-Strategy2'
config.test_source_root = os.path.dirname(__file__)
config.test_format = lit.formats.ShTest(execute_external=True)
config.suffixes = ['.cpp', '.c']

cheerp_base = '/opt/cheerp/bin/clang++'
cheerp_flags = os.environ.get('CHEERP_FLAGS', '')
extra_flags = os.environ.get('EXTRA_FLAGS', '')

cheerp_targets = ["js", "wasm", "asmjs"]
targets_csv = lit_config.params.get("TARGETS", "").strip()

if targets_csv:
    selected_targets = set([t.strip().lower() for t in targets_csv.split(",")])
else:
    selected_targets = set(cheerp_targets)

has_js = "js" in selected_targets
has_wasm = "wasm" in selected_targets
has_asmjs = "asmjs" in selected_targets

lit_config.note('Strategy 2: Python Macros - Selected targets: {}'.format(selected_targets))

all_flags = ' '.join(filter(None, [cheerp_flags, extra_flags]))
cheerp_cmd = cheerp_base + (' ' + all_flags if all_flags else '')

# Basic substitutions
config.substitutions.append(('%cheerp_clang', cheerp_cmd))
config.substitutions.append(('%FileCheck', '/usr/bin/FileCheck-20'))
config.substitutions.append(('%node', 'node'))

# Macro-style conditional compilation commands
# These expand %compile_TARGET{args} into conditional compile statements
if has_wasm:
    config.substitutions.append((r'%compile_wasm\{([^}]+)\}', 
                                  cheerp_cmd + r' -target cheerp-wasm \1'))
else:
    config.substitutions.append((r'%compile_wasm\{([^}]+)\}', 'true'))

if has_js:
    config.substitutions.append((r'%compile_js\{([^}]+)\}', 
                                  cheerp_cmd + r' -target cheerp \1'))
else:
    config.substitutions.append((r'%compile_js\{([^}]+)\}', 'true'))

if has_asmjs:
    config.substitutions.append((r'%compile_asmjs\{([^}]+)\}', 
                                  cheerp_cmd + r' -target cheerp-asmjs \1'))
else:
    config.substitutions.append((r'%compile_asmjs\{([^}]+)\}', 'true'))

# Macro-style conditional execution commands
# These expand %if_TARGET{cmd} into: if has_target; then cmd; fi (or just 'true' if disabled)
if has_wasm:
    config.substitutions.append((r'%if_wasm\{([^}]+)\}', r'\1'))
else:
    config.substitutions.append((r'%if_wasm\{([^}]+)\}', 'true'))

if has_js:
    config.substitutions.append((r'%if_js\{([^}]+)\}', r'\1'))
else:
    config.substitutions.append((r'%if_js\{([^}]+)\}', 'true'))

if has_asmjs:
    config.substitutions.append((r'%if_asmjs\{([^}]+)\}', r'\1'))
else:
    config.substitutions.append((r'%if_asmjs\{([^}]+)\}', 'true'))

config.test_exec_root = os.path.dirname(__file__)
if 'PATH' in os.environ:
    config.environment['PATH'] = os.environ['PATH']
