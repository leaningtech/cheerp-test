# Variant: Separate files per target with REQUIRES directives
# Each test file is specific to one target and uses REQUIRES to gate execution

import lit.formats
import os

config.name = 'Cheerp-Strategy2-Separate'
config.test_source_root = os.path.dirname(__file__)
config.test_format = lit.formats.ShTest(execute_external=True)
config.suffixes = ['.cpp', '.c']

cheerp_base = '/opt/cheerp/bin/clang++'
cheerp_flags = os.environ.get('CHEERP_FLAGS', '')
extra_flags = os.environ.get('EXTRA_FLAGS', '')
preexecute_mode = os.environ.get('PREEXECUTE_MODE', 'false').lower() == 'true'

cheerp_targets = ["js", "wasm", "asmjs"]
targets_csv = lit_config.params.get("TARGETS", "").strip()

if targets_csv:
    selected_targets = set([t.strip().lower() for t in targets_csv.split(",")])
else:
    selected_targets = set(cheerp_targets)

# Add features based on selected targets
if "js" in selected_targets:
    config.available_features.add('js')
if "wasm" in selected_targets:
    config.available_features.add('wasm')
if "asmjs" in selected_targets:
    config.available_features.add('asmjs')

# Add preexecution feature if enabled
if preexecute_mode:
    config.available_features.add('preexecute')

lit_config.note('Strategy 2 Separate Files - Selected targets: {}'.format(selected_targets))

if preexecute_mode:
    lit_config.note('Strategy 2: PREEXECUTION MODE ENABLED')

all_flags = ' '.join(filter(None, [cheerp_flags, extra_flags]))
cheerp_cmd = cheerp_base + (' ' + all_flags if all_flags else '')

# Preexecution-specific flags
preexecute_flags = '-DPRE_EXECUTE_TEST -cheerp-preexecute -mllvm -cheerp-preexecute-main'
if preexecute_mode:
    cheerp_cmd_preexec = cheerp_base + ' ' + preexecute_flags + (' ' + all_flags if all_flags else '')
else:
    cheerp_cmd_preexec = None

config.substitutions.append(('%cheerp_clang', cheerp_cmd))
if preexecute_mode and cheerp_cmd_preexec:
    config.substitutions.append(('%cheerp_clang_preexec', cheerp_cmd_preexec))
config.substitutions.append(('%FileCheck', '/usr/bin/FileCheck-20'))
config.substitutions.append(('%node', 'node'))

config.test_exec_root = os.path.dirname(__file__)
# Ensure Cheerp tools (like llc for -cheerp-no-lto) are in PATH
if 'PATH' in os.environ:
    config.environment['PATH'] = '/opt/cheerp/bin:' + os.environ['PATH']
else:
    config.environment['PATH'] = '/opt/cheerp/bin:/usr/bin:/bin'
